# 取り扱い手順書：LangGraph搭載 自律型リサーチエージェント

## 1. ドキュメント情報

- **文書名**: 取り扱い手順書
- **バージョン**: 1.2
- **作成日**: 2024-12-27
- **最終更新日**: 2025-02-01
- **対象システム**: LangGraph搭載 自律型リサーチエージェント
- **対象読者**: システム管理者、開発者、エンドユーザー

---

## 2. 目次

1. [システム概要](#3-システム概要)
2. [インストール手順](#4-インストール手順)
3. [設定方法](#5-設定方法)
4. [基本的な使用方法](#6-基本的な使用方法)
5. [API使用方法](#7-api使用方法)
6. [GUI使用方法（HTML GUI / Streamlit）](#8-gui使用方法html-gui--streamlit)
7. [トラブルシューティング](#9-トラブルシューティング)
8. [メンテナンス](#10-メンテナンス)
9. [付録](#11-付録)

---

## 3. システム概要

### 3.1 システムの目的

LangGraph搭載 自律型リサーチエージェントは、ユーザーが指定したテーマについて、Web上の情報を自動的に収集・分析し、高品質なレポートを生成するシステムです。

### 3.2 主要機能

- **Supervisor**: 調査計画の立案とルーティング決定
- **Researcher**: Web検索と情報収集（並列検索対応）
- **Writer**: レポートドラフトの生成
- **Reviewer**: ドラフトの評価とフィードバック
- **チェックポイント機能**: 実行状態の永続化
- **Human-in-the-Loop**: 人間介入による制御
- **REST API**: HTTP APIによる操作
- **参照ソース要約機能**: LLMを使用して各参照ソースの要約を自動生成
- **PDF生成機能**: 参照ソースをPDF形式でダウンロード可能
- **Gemini対応**: OpenAIに加えて、Google Geminiも使用可能

### 3.3 システム要件

#### 3.3.1 ハードウェア要件

- **CPU**: 2コア以上推奨
- **メモリ**: 4GB以上推奨
- **ストレージ**: 1GB以上の空き容量

#### 3.3.2 ソフトウェア要件

- **OS**: Windows 10/11, macOS 10.15+, Linux (Ubuntu 20.04+)
- **Python**: 3.10以上
- **インターネット接続**: 必須（API呼び出しのため）

#### 3.3.3 必要なAPIキー

- **OpenAI API Key** または **Gemini API Key**: LLMを使用するため（どちらか一方。開発・テスト時は `LLM_PROVIDER=mock` でAPIキー不要）
- **Tavily API Key**: Web検索APIを使用するため（必須）
- **Redis** (オプション): チェックポイント機能で使用

---

## 4. インストール手順

### 4.1 前提条件の確認

インストール前に、以下のコマンドでPythonのバージョンを確認してください：

```bash
python --version
# Python 3.10以上であることを確認
```

### 4.2 プロジェクトの取得

プロジェクトをクローンまたはダウンロードします：

```bash
# Gitを使用する場合
git clone <repository-url>
cd deep_research_agent_langgraph

# または、ZIPファイルをダウンロードして展開
```

### 4.3 仮想環境の作成

プロジェクトディレクトリで仮想環境を作成します：

```bash
# Windows
python -m venv venv
venv\Scripts\activate

# macOS/Linux
python -m venv venv
source venv/bin/activate
```

仮想環境が有効になると、プロンプトに `(venv)` が表示されます。

### 4.4 依存関係のインストール

```bash
pip install -r requirements.txt
```

インストールには数分かかる場合があります。

### 4.5 インストール確認

インストールが正常に完了したか確認します：

```bash
python -c "import langchain; import langgraph; print('インストール成功')"
```

エラーが表示されない場合は、インストールは成功しています。

---

## 5. 設定方法

### 5.1 環境変数の設定

プロジェクトルートに `.env` ファイルを作成し、以下の内容を記述します。雛形として `.env_example` をコピーして編集しても構いません。

```bash
# Windows (PowerShell)
copy .env_example .env

# Linux / macOS
cp .env_example .env
```

```env
# LLMプロバイダー設定（openai または gemini）
LLM_PROVIDER=openai

# OpenAI設定（LLM_PROVIDER=openaiの場合）
OPENAI_API_KEY=your-openai-api-key-here
OPENAI_MODEL=gpt-4o

# Gemini設定（LLM_PROVIDER=geminiの場合）
GEMINI_API_KEY=your-gemini-api-key-here
GEMINI_MODEL=gemini-3-flash

# Tavily設定（必須）
TAVILY_API_KEY=your-tavily-api-key-here

# Redis設定（オプション）
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_DB=0

# 制限設定（オプション）
MAX_ITERATIONS=5
MAX_SEARCH_RESULTS=10
MAX_RESULTS_PER_QUERY=5
SUMMARY_MAX_LENGTH=300  # URL要約の最大文字数

# API認証設定（オプション）
ALLOWED_API_KEYS=key1,key2,key3
ENABLE_API_AUTH=false

# レート制限設定（オプション）
RATE_LIMIT_REQUESTS_PER_MINUTE=60
ENABLE_RATE_LIMIT=true

# LangSmith設定（オプション）
LANGCHAIN_TRACING_V2=false
LANGCHAIN_API_KEY=
LANGCHAIN_PROJECT=research-agent
```

### 5.2 APIキーの取得方法

#### 5.2.1 OpenAI API Key

1. [OpenAI Platform](https://platform.openai.com/) にアクセス
2. アカウントを作成またはログイン
3. 「API Keys」セクションに移動
4. 「Create new secret key」をクリック
5. 生成されたキーをコピーして `.env` ファイルに設定

**注意**: APIキーは一度しか表示されません。安全に保管してください。

#### 5.2.2 Tavily API Key

1. [Tavily](https://tavily.com/) にアクセス
2. アカウントを作成またはログイン
3. ダッシュボードからAPIキーを取得
4. `.env` ファイルに設定

#### 5.2.3 Gemini API Key（オプション）

Geminiを使用する場合：

1. [Google AI Studio](https://makersuite.google.com/app/apikey) にアクセス
2. アカウントを作成またはログイン
3. APIキーを作成
4. `.env` ファイルに設定：
   ```env
   LLM_PROVIDER=gemini
   GEMINI_API_KEY=your-gemini-api-key-here
   GEMINI_MODEL=gemini-3-flash
   ```

### 5.3 設定の確認

設定が正しく読み込まれているか確認します：

```bash
python -c "from src.config.settings import Settings; s = Settings(); print(f'OpenAI Model: {s.OPENAI_MODEL}')"
```

エラーが表示されない場合は、設定は正常です。

---

## 6. 基本的な使用方法

### 6.1 直接実行による使用

最もシンプルな使用方法です。Pythonスクリプトを直接実行します。

#### 6.1.1 基本的な実行

```bash
python examples/example_usage.py
```

このコマンドを実行すると、デフォルトのテーマ（"LangGraphについて調査してください"）でリサーチが開始されます。

#### 6.1.2 カスタムテーマでの実行

`examples/example_usage.py` を編集して、テーマを変更します：

```python
# 58行目付近を変更
theme = "あなたの調査テーマをここに記述"
```

### 6.2 プログラムからの使用

独自のPythonスクリプトから使用する場合：

```python
from langchain_core.messages import HumanMessage
from src.graph.graph_builder import build_graph
from src.graph.state import ResearchState

# グラフを構築
graph = build_graph()

# 初期ステートを作成
initial_state: ResearchState = {
    "messages": [HumanMessage(content="調査テーマ")],
    "task_plan": None,
    "research_data": [],
    "current_draft": None,
    "feedback": None,
    "iteration_count": 0,
    "next_action": "research",
    "human_input_required": False,
    "human_input": None
}

# 設定
config = {
    "configurable": {
        "thread_id": "unique-thread-id"
    }
}

# 実行
result = graph.invoke(initial_state, config)

# 結果の確認
print(f"イテレーション回数: {result['iteration_count']}")
print(f"収集データ数: {len(result['research_data'])}")
if result.get("current_draft"):
    print(result["current_draft"])
```

### 6.3 実行フローの理解

システムは以下のフローで動作します：

1. **Supervisor**: 調査計画を立案
2. **Researcher**: Web検索を実行（並列処理）
3. **Writer**: レポートドラフトを生成
4. **Reviewer**: ドラフトを評価
5. 承認されない場合は、フィードバックに基づいて再生成
6. 最大イテレーション数に達するか、承認されるまで繰り返し

---

## 7. API使用方法

### 7.1 APIサーバーの起動

**Windows（推奨）**:

```batch
start_api_server.bat
```

**Pythonスクリプト**:

```bash
python run_api_server.py
```

**uvicorn で直接起動**:

```bash
uvicorn src.api.main:app --reload
```

`--reload` オプションを付けると、コード変更時に自動的に再起動されます。プロジェクトルートから実行してください。

サーバーが起動すると、以下のメッセージが表示されます：

```
INFO:     Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit)
```

### 7.2 APIドキュメントの確認

ブラウザで以下のURLにアクセスすると、インタラクティブなAPIドキュメントが表示されます：

```
http://localhost:8000/docs
```

### 7.3 基本的なAPI操作

#### 7.3.1 リサーチの開始

```bash
curl -X POST "http://localhost:8000/research" \
  -H "Content-Type: application/json" \
  -d '{
    "theme": "LangGraphについて調査してください",
    "max_iterations": 5,
    "enable_human_intervention": false,
    "checkpointer_type": "memory"
  }'
```

レスポンス例：

```json
{
  "research_id": "550e8400-e29b-41d4-a716-446655440000",
  "status": "started",
  "message": "リサーチを開始しました",
  "created_at": "2024-12-27T10:00:00",
  "estimated_completion_time": "2024-12-27T10:02:30"
}
```

#### 7.3.2 ステータスの確認

```bash
curl "http://localhost:8000/research/{research_id}/status"
```

レスポンス例：

```json
{
  "research_id": "550e8400-e29b-41d4-a716-446655440000",
  "status": "processing",
  "progress": {
    "current_iteration": 2,
    "max_iterations": 5,
    "current_node": "researcher",
    "nodes_completed": [],
    "nodes_remaining": []
  },
  "statistics": {
    "iterations": 2,
    "sources_collected": 15,
    "processing_time_seconds": 45
  },
  "last_updated": "2024-12-27T10:00:45"
}
```

#### 7.3.3 結果の取得

```bash
curl "http://localhost:8000/research/{research_id}"
```

**注意**: リサーチが完了するまで（`status` が `completed` になるまで）は、422エラーが返されます。

#### 7.3.4 ストリーミング（進捗のリアルタイム監視）

```bash
curl "http://localhost:8000/research/{research_id}/stream"
```

Server-Sent Events (SSE) 形式で進捗がストリーミングされます。

### 7.4 API認証の設定

本番環境では、API認証を有効化することを推奨します：

1. `.env` ファイルで `ENABLE_API_AUTH=true` を設定
2. `ALLOWED_API_KEYS` に許可するAPIキーをカンマ区切りで設定

```env
ENABLE_API_AUTH=true
ALLOWED_API_KEYS=your-api-key-1,your-api-key-2
```

認証が有効な場合、リクエストにAPIキーを含める必要があります：

```bash
curl -X POST "http://localhost:8000/research" \
  -H "X-API-Key: your-api-key-1" \
  -H "Content-Type: application/json" \
  -d '{...}'
```

または、Bearerトークンとして：

```bash
curl -X POST "http://localhost:8000/research" \
  -H "Authorization: Bearer your-api-key-1" \
  -H "Content-Type: application/json" \
  -d '{...}'
```

### 7.5 Pythonクライアントの使用

APIは curl、HTML GUI（`gui/index.html`）、または自作のPythonスクリプトから利用できます。Pythonから呼び出す例：

```python
import requests

# リサーチを開始
response = requests.post(
    "http://localhost:8000/research",
    json={
        "theme": "調査テーマ",
        "max_iterations": 5
    }
)
research_id = response.json()["research_id"]

# ステータスを確認
status_response = requests.get(f"http://localhost:8000/research/{research_id}/status")
print(status_response.json())
```

---

## 8. GUI使用方法（HTML GUI / Streamlit）

### 8.1 概要

本システムでは次の2種類のGUIを利用できます。

- **HTML GUI（推奨）**: `gui/` 配下の HTML/CSS/JavaScript で実装。APIサーバー起動後、ブラウザで `gui/index.html` を開くか、`start_html_gui.bat`（Windows）で起動。
- **Streamlit GUI（オプション）**: `examples/api_usage_with_chat_gui.py` を用意している場合、`run_gui.py` または `start_gui.bat` で起動可能。

いずれも **APIサーバーを先に起動** する必要があります。

### 8.2 起動方法

#### 8.2.1 前提条件

1. **APIサーバーの起動**: GUIを使用するには、まずAPIサーバーを起動してください。

```bash
# 方法1: バッチファイル（Windows）
start_api_server.bat

# 方法2: Pythonスクリプト
python run_api_server.py

# 方法3: uvicorn で直接起動
uvicorn src.api.main:app --reload
```

2. **環境変数の設定**: `.env` ファイルまたは環境変数に以下を設定します。

```env
OPENAI_API_KEY=your_openai_api_key
TAVILY_API_KEY=your_tavily_api_key
API_BASE_URL=http://localhost:8000

# データベース永続化を使用する場合（オプション）
DATABASE_URL=postgresql://user:password@localhost:5432/dbname
ENABLE_DB_PERSISTENCE=true
```

#### 8.2.2 HTML GUI の起動（推奨）

- **Windows**: `start_html_gui.bat` を実行すると、ブラウザで `gui/index.html` が開きます。
- **手動**: ブラウザで `gui/index.html` をファイルとして開く（`file:///...`）。
- **簡易Webサーバー**: `cd gui` のあと `python -m http.server 8080` を実行し、`http://localhost:8080` にアクセス。

詳細は `gui/README.md` を参照してください。

**一括起動（Windows）**: APIサーバーとHTML GUI用の簡易サーバーをまとめて起動する場合は `deep_research_agent_langgraph.bat` を実行してください。

#### 8.2.3 Streamlit GUI の起動（オプション）

`examples/api_usage_with_chat_gui.py` が存在する場合のみ利用可能です。

- **Windows**: `start_gui.bat` を実行
- **コマンド**: `python run_gui.py` または `streamlit run examples/api_usage_with_chat_gui.py`

起動すると、ブラウザが開き、次のような表示になります：

```
Local URL: http://localhost:8501
Network URL: http://192.168.x.x:8501
```

### 8.3 基本的な操作

#### 8.3.1 リサーチの開始

1. **チャット入力欄**に調査テーマを入力します
   - 例: "LangGraphについて調査してください"
   - 例: "Pythonの非同期処理について"

2. **Enterキー**を押すか、送信ボタンをクリックします

3. リサーチが開始され、進捗がリアルタイムで表示されます

#### 8.3.2 進捗の確認

リサーチ実行中は、以下の情報が表示されます：

- **プログレスバー**: イテレーションの進捗
- **リアルタイム情報**:
  - 現在のイテレーション数
  - 収集されたソース数
  - 現在実行中のノード（supervisor, researcher, writer, reviewer）

#### 8.3.3 結果の確認

リサーチが完了すると、以下の情報が表示されます：

- **統計情報**:
  - イテレーション回数
  - 収集ソース数
  - 処理時間

- **レポート**: Markdown形式でレンダリングされたレポート
  - レポート本文内の参照番号（[1], [2]など）は、参照ソースへのリンクとして表示されます
  - Footnotesセクションは表示されず、参照番号が直接リンクになっています

- **参照ソース**: 使用された情報源のリスト
  - 各ソースには以下の情報が表示されます：
    - タイトル
    - URL
    - 要約（LLMで生成された300文字以内の要約）
    - 関連性スコア

#### 8.3.4 レポートのダウンロード

レポート表示画面の「📥 レポートをダウンロード」ボタンをクリックすると、Markdown形式でレポートをダウンロードできます。

ダウンロードされるMarkdownファイルには、以下の情報が含まれます：
- レポート本文
- 参照ソース一覧（タイトル、URL、要約、関連性スコア）

#### 8.3.5 参照ソースのPDFダウンロード

参照ソースセクションでは、以下の機能が利用できます：

1. **ソースの選択**:
   - 各参照ソースの左側にチェックボックスが表示されます
   - 必要なソースにチェックを入れて選択します
   - 「✅ すべて選択」ボタンで全ソースを選択、「❌ すべて解除」ボタンで選択を解除できます

2. **PDF生成**:
   - 選択したソースに対して「📥 選択したX件のソースページをPDFで生成」ボタンをクリックします
   - 各ソースごとに個別のPDFファイルが生成されます
   - PDFには以下の情報が含まれます：
     - ソースのタイトル
     - URL
     - 要約（LLMで生成された要約）
     - ページの本文（HTMLから抽出、またはPDFから抽出）

3. **PDFダウンロード**:
   - PDF生成が完了すると、各PDFのダウンロードボタンが表示されます
   - ボタンをクリックしてPDFをダウンロードできます
   - PDFファイル名は、ソースのタイトルに基づいて自動生成されます

**注意事項**:
- PDF生成には`reportlab`ライブラリが必要です（`requirements.txt`に含まれています）
- PDFファイルのURLは直接ダウンロードされます
- HTMLページの場合は、`trafilatura`を使用して記事コンテンツのみを抽出します
- PDF生成には時間がかかる場合があります（各URL先のページを取得するため）

### 8.4 サイドバー機能

#### 8.4.1 新規チャット

「➕ 新規チャット」ボタンをクリックすると、新しい会話セッションを開始できます。

#### 8.4.2 履歴管理

- **履歴表示**: 過去のリサーチ履歴が一覧表示されます
- **履歴の選択**: 履歴をクリックすると、そのリサーチの結果を表示できます
- **履歴の削除**: 🗑️ボタンをクリックすると履歴を削除できます

#### 8.4.3 設定

- **最大イテレーション数**: スライダーで1〜10の範囲で設定できます（デフォルト: 5）
- **人間介入を有効化**: チェックボックスで有効/無効を切り替えできます
- **タイトルを自動生成**: LLMを使用したタイトル自動生成の有効/無効を設定できます

#### 8.4.4 DBから履歴を読み込み

データベース永続化が有効な場合、「🔄 DBから履歴を読み込み」ボタンでデータベースから履歴を読み込めます。

#### 8.4.5 ヘルスチェック

「🏥 ヘルスチェック」ボタンでAPIサーバーの状態を確認できます。

### 8.5 高度な機能

#### 8.5.1 再生成機能

- **メッセージの再生成**: アシスタントメッセージの「🔄 再生成」ボタンで、同じテーマでリサーチを再実行できます
- **レポートの再生成**: レポート表示画面の「🔄 再生成」ボタンで、同じテーマでリサーチを再実行できます

#### 8.5.2 停止機能

リサーチ実行中に「⏹️ 停止」ボタンをクリックすると、リサーチを中断できます。

#### 8.5.3 中断されたリサーチの再開

人間介入が有効な場合、リサーチが中断されたら入力欄に指示を入力し、「再開」ボタンをクリックします。

### 8.6 データベース永続化機能

#### 8.6.1 セットアップ

1. **PostgreSQLのインストール**: PostgreSQLをインストールし、データベースを作成します

2. **環境変数の設定**: `.env`ファイルに以下を追加します

```env
DATABASE_URL=postgresql://user:password@localhost:5432/dbname
ENABLE_DB_PERSISTENCE=true
```

3. **依存関係のインストール**: データベース関連のパッケージがインストールされていることを確認します

```bash
pip install sqlalchemy psycopg2-binary alembic
```

#### 8.6.2 使用方法

- **自動保存**: メッセージとリサーチ履歴は自動的にデータベースに保存されます
- **履歴の読み込み**: サイドバーの「🔄 DBから履歴を読み込み」ボタンで読み込みます
- **タイトル自動生成**: LLMを使用してタイトルを自動生成します（設定で有効化）

詳細は `README_DB.md` を参照してください。

### 8.7 トラブルシューティング（GUI関連）

#### 8.7.1 GUIが起動しない

**HTML GUI の場合**  
- `gui/index.html` が存在するか確認する  
- `start_html_gui.bat` はプロジェクトルートから実行する  
- 詳細は `gui/README.md` を参照

**Streamlit GUI の場合**  
- **症状**: `streamlit run` コマンドを実行してもブラウザが開かない  
- **解決方法**:
  1. Streamlitがインストールされているか確認：`pip install streamlit`
  2. ポート8501が使用されていないか確認
  3. ファイアウォールの設定を確認
  4. `examples/api_usage_with_chat_gui.py` が存在するか確認（存在しない場合は Streamlit GUI は利用不可）

#### 8.7.2 APIサーバーに接続できない

**症状**: 「❌ APIサーバーに接続できません」というエラーが表示される

**解決方法**:
1. APIサーバーが起動しているか確認
2. `API_BASE_URL`環境変数が正しく設定されているか確認
3. ヘルスチェックボタンで接続を確認

#### 8.7.3 データベース接続エラー

**症状**: 「データベースモジュールのインポートに失敗しました」という警告が表示される

**解決方法**:
1. データベース関連のパッケージがインストールされているか確認
2. `DATABASE_URL`が正しく設定されているか確認
3. PostgreSQLが起動しているか確認
4. データベースとユーザーが作成されているか確認

**注意**: データベース永続化はオプション機能です。エラーが発生してもGUIアプリケーションは動作します（警告が表示されます）。

#### 8.7.4 タイトル自動生成が動作しない

**症状**: LLMタイトル生成が実行されない

**解決方法**:
1. `OPENAI_API_KEY`が設定されているか確認
2. サイドバーの「タイトルを自動生成」チェックボックスが有効になっているか確認
3. APIキーが有効か確認

エラー時はフォールバック機能が動作し、テーマから簡単なタイトルが生成されます。

#### 8.7.5 履歴が表示されない

**症状**: サイドバーに履歴が表示されない

**解決方法**:
1. リサーチが正常に完了しているか確認
2. データベース永続化を使用している場合、「🔄 DBから履歴を読み込み」ボタンをクリック
3. ブラウザのキャッシュをクリアしてページを再読み込み

#### 8.7.6 PDF生成が失敗する

**症状**: PDF生成ボタンをクリックしてもPDFが生成されない、またはエラーが表示される

**解決方法**:
1. `reportlab`がインストールされているか確認：
   ```bash
   pip install reportlab
   ```
2. `trafilatura`がインストールされているか確認（HTMLページのコンテンツ抽出用）：
   ```bash
   pip install trafilatura
   ```
3. `PyPDF2`がインストールされているか確認（PDFファイルからのテキスト抽出用）：
   ```bash
   pip install PyPDF2
   ```
4. ネットワーク接続を確認（URL先のページを取得するため）
5. ブラウザのコンソールでエラーメッセージを確認

#### 8.7.7 参照ソースのチェックボックスが動作しない

**症状**: チェックボックスをクリックしてもチェックがつかない、または表示が消える

**解決方法**:
1. ブラウザのページを再読み込み（F5キー）
2. Streamlitのキャッシュをクリア：
   - ブラウザの開発者ツール（F12）を開く
   - Application > Storage > Clear site data
3. ブラウザのキャッシュをクリアして再起動

### 8.8 ショートカットとヒント

#### 8.8.1 効率的な使用方法

1. **複数のリサーチを並行実行**: 複数のブラウザタブを開いて、異なるテーマでリサーチを実行できます
2. **履歴の活用**: 過去のリサーチ結果を参照して、新しいリサーチの参考にできます
3. **設定の調整**: イテレーション数を調整して、リサーチの深さを制御できます

#### 8.8.2 パフォーマンスの最適化

- **イテレーション数の調整**: 浅い調査の場合はイテレーション数を減らす
- **人間介入の無効化**: 自動実行の場合は人間介入を無効にする
- **データベースの使用**: 大量の履歴を管理する場合はデータベース永続化を使用

---

## 9. トラブルシューティング

### 9.1 よくある問題と解決方法

#### 9.1.1 APIキーエラー

**症状**: `ValueError: OPENAI_API_KEY環境変数が設定されていません`

**解決方法**:
1. `.env` ファイルがプロジェクトルートに存在するか確認
2. `.env` ファイルに `OPENAI_API_KEY` が正しく設定されているか確認
3. 環境変数が正しく読み込まれているか確認：
   ```bash
   python -c "from src.config.settings import Settings; s = Settings(); print(s.OPENAI_API_KEY[:10])"
   ```

#### 9.1.2 モジュールが見つからないエラー

**症状**: `ModuleNotFoundError: No module named 'src'`

**解決方法**:
1. プロジェクトルートディレクトリから実行しているか確認
2. 仮想環境が有効になっているか確認
3. 依存関係がインストールされているか確認：
   ```bash
   pip install -r requirements.txt
   ```

#### 9.1.3 検索結果が取得できない

**症状**: 検索結果が空、またはエラーが発生する

**解決方法**:
1. Tavily APIキーが正しく設定されているか確認
2. インターネット接続を確認
3. Tavily APIのレート制限に達していないか確認
4. 検索クエリが適切か確認（具体的すぎる、または曖昧すぎるクエリは避ける）

#### 9.1.4 レポートが生成されない

**症状**: `current_draft` が `None` のまま

**解決方法**:
1. 最大イテレーション数を増やす（デフォルトは5）
2. 調査テーマをより具体的にする
3. ログを確認してエラーがないか確認：
   ```bash
   # ログレベルをDEBUGに設定
   export LOG_LEVEL=DEBUG
   python examples/example_usage.py
   ```

#### 9.1.5 APIサーバーが起動しない

**症状**: `Address already in use` エラー

**解決方法**:
1. 既に起動しているサーバーを停止：
   ```bash
   # Windows
   netstat -ano | findstr :8000
   taskkill /PID <PID> /F
   
   # macOS/Linux
   lsof -ti:8000 | xargs kill -9
   ```
2. 別のポートを使用：
   ```bash
   uvicorn src.api.main:app --port 8001
   ```

#### 9.1.6 レート制限エラー

**症状**: `429 Too Many Requests` エラー

**解決方法**:
1. リクエスト頻度を下げる
2. レート制限の設定を確認（`.env` の `RATE_LIMIT_REQUESTS_PER_MINUTE`）
3. 必要に応じてレート制限を無効化（開発環境のみ）：
   ```env
   ENABLE_RATE_LIMIT=false
   ```

### 9.2 ログの確認

問題の診断には、ログを確認することが重要です。

#### 9.2.1 ログレベルの設定

`.env` ファイルまたは環境変数で設定：

```env
LOG_LEVEL=DEBUG  # DEBUG, INFO, WARNING, ERROR
```

#### 9.2.2 ログファイルの場所

デフォルトでは、コンソールに出力されます。ファイルに出力する場合は、`src/utils/logger.py` を編集してください。

### 9.3 パフォーマンスの問題

#### 9.3.1 実行が遅い

- 並列検索が有効になっているか確認（デフォルトで有効）
- キャッシュが機能しているか確認
- ネットワーク接続を確認
- APIの応答時間を確認

#### 9.3.2 メモリ使用量が多い

- 最大イテレーション数を減らす
- 最大検索結果数を減らす（`MAX_RESULTS_PER_QUERY`）
- 定期的にキャッシュをクリア

---

## 10. メンテナンス

### 10.1 定期的なメンテナンス

#### 10.1.1 キャッシュのクリア

キャッシュが大きくなりすぎた場合：

```python
from src.utils.cache import clear_all_caches
clear_all_caches()
```

#### 10.1.2 ログファイルのローテーション

大量のログが生成される場合、ログローテーションを設定することを推奨します。

#### 10.1.3 依存関係の更新

定期的に依存関係を更新：

```bash
pip install --upgrade -r requirements.txt
```

**注意**: メジャーバージョンの更新は、互換性の問題を引き起こす可能性があります。テスト環境で確認してから本番環境に適用してください。

### 10.2 バックアップ

#### 10.2.1 設定ファイルのバックアップ

`.env` ファイルは機密情報を含むため、安全に保管してください。

#### 10.2.2 チェックポイントデータのバックアップ

Redisを使用している場合、定期的にバックアップを取得してください。

### 10.3 セキュリティ

#### 10.3.1 APIキーの管理

- APIキーは `.env` ファイルに保存し、Gitにコミットしない
- `.gitignore` に `.env` が含まれているか確認
- 本番環境では、環境変数またはシークレット管理サービスを使用

#### 10.3.2 アクセス制御

- 本番環境では、API認証を有効化
- レート制限を適切に設定
- 必要に応じて、IPアドレス制限を追加

---

## 11. 付録

### 11.1 環境変数一覧

| 変数名 | 必須 | デフォルト値 | 説明 |
|--------|------|------------|------|
| `LLM_PROVIDER` | いいえ | `openai` | 使用するLLMプロバイダー（`openai` / `gemini` / `mock`。`mock` は開発・テスト用でAPIキー不要） |
| `OPENAI_API_KEY` | 条件付き | - | OpenAI APIキー（`LLM_PROVIDER=openai`の場合に必須） |
| `OPENAI_MODEL` | いいえ | `gpt-4o` | 使用するOpenAIモデル |
| `GEMINI_API_KEY` | 条件付き | - | Gemini APIキー（`LLM_PROVIDER=gemini`の場合に必須） |
| `GEMINI_MODEL` | いいえ | `gemini-3-flash` | 使用するGeminiモデル |
| `TAVILY_API_KEY` | はい | - | Tavily APIキー |
| `SUMMARY_MAX_LENGTH` | いいえ | `300` | URL要約の最大文字数 |
| `DOWNLOAD_SAVE_DIR` | いいえ | `""` | レポートMD・参照ソースPDFのダウンロード時にサーバー側にも保存するディレクトリ（未設定時は保存しない） |
| `REDIS_HOST` | いいえ | `localhost` | Redisホスト |
| `REDIS_PORT` | いいえ | `6379` | Redisポート |
| `REDIS_DB` | いいえ | `0` | Redisデータベース番号 |
| `MAX_ITERATIONS` | いいえ | `5` | 最大イテレーション数 |
| `MAX_SEARCH_RESULTS` | いいえ | `10` | 最大検索結果数 |
| `MAX_RESULTS_PER_QUERY` | いいえ | `5` | クエリあたりの最大結果数 |
| `ALLOWED_API_KEYS` | いいえ | `""` | 許可されたAPIキー（カンマ区切り） |
| `ENABLE_API_AUTH` | いいえ | `false` | API認証を有効化するか |
| `RATE_LIMIT_REQUESTS_PER_MINUTE` | いいえ | `60` | 1分あたりのリクエスト数制限 |
| `ENABLE_RATE_LIMIT` | いいえ | `true` | レート制限を有効化するか |
| `LANGCHAIN_TRACING_V2` | いいえ | `false` | LangSmithトレーシングを有効化するか |
| `LANGCHAIN_API_KEY` | いいえ | - | LangSmith APIキー |
| `LANGCHAIN_PROJECT` | いいえ | `research-agent` | LangSmithプロジェクト名 |

### 11.2 APIエンドポイント一覧

| メソッド | エンドポイント | 説明 |
|---------|---------------|------|
| POST | `/research` | リサーチを開始 |
| GET | `/research/{id}` | リサーチ結果を取得 |
| GET | `/research/{id}/status` | リサーチのステータスを取得 |
| GET | `/research/{id}/stream` | 進捗をストリーミング |
| POST | `/research/{id}/resume` | 中断されたリサーチを再開 |
| DELETE | `/research/{id}` | リサーチを削除 |
| GET | `/health` | ヘルスチェック |

### 11.3 ステータス一覧

| ステータス | 説明 |
|-----------|------|
| `started` | リサーチが開始された |
| `processing` | リサーチが実行中 |
| `completed` | リサーチが完了 |
| `failed` | リサーチが失敗 |
| `interrupted` | 人間介入待ちで中断 |

### 11.4 エラーコード一覧

| HTTPステータス | 説明 |
|---------------|------|
| 200 | 成功 |
| 201 | 作成成功 |
| 400 | リクエストエラー（バリデーションエラーなど） |
| 401 | 認証エラー |
| 404 | リソースが見つからない |
| 422 | 処理中（結果がまだ利用できない） |
| 429 | レート制限超過 |
| 500 | サーバー内部エラー |

### 11.5 サポートと連絡先

問題が解決しない場合：

1. ログファイルを確認
2. GitHubのIssuesに報告（該当する場合）
3. ドキュメントを再確認

### 11.6 参考資料

- [LangGraph公式ドキュメント](https://langchain-ai.github.io/langgraph/)
- [LangChain公式ドキュメント](https://python.langchain.com/)
- [FastAPI公式ドキュメント](https://fastapi.tiangolo.com/)
- [OpenAI APIドキュメント](https://platform.openai.com/docs)
- [Tavily APIドキュメント](https://docs.tavily.com/)

---

## 12. 変更履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| 1.0 | 2024-12-27 | 初版作成 |
| 1.1 | 2025-01-25 | PDF生成機能追加、参照ソース要約機能追加、Gemini対応追加、レポート内参照リンク機能追加 |
| 1.2 | 2025-02-01 | HTML GUI の追記、.env_example の説明追加、API起動方法（run_api_server.py / start_api_server.bat）追加、章番号・目次修正、mock オプション・DOWNLOAD_SAVE_DIR の記載追加 |

---

**注意**: この手順書は、システムの基本的な使用方法を説明しています。詳細な技術情報については、各設計書を参照してください。

