# データモデル定義書：LangGraph搭載 自律型リサーチエージェント

## 1. ドキュメント情報

- **文書名**: データモデル定義書
- **バージョン**: 1.0
- **作成日**: 2024-12-27
- **対象システム**: LangGraph搭載 自律型リサーチエージェント
- **参照文書**: 要求定義書、基本設計書、詳細設計書、API仕様書

---

## 2. データモデル概要

### 2.1 概要

本システムで使用するすべてのデータモデルをPydantic 2.0以上を使用して定義します。型安全性とバリデーションを保証します。

### 2.2 モデル一覧

| モデル名 | 説明 | ファイル |
|---------|------|---------|
| ResearchState | LangGraphの共有ステート | `src/graph/state.py` |
| ResearchPlan | 調査計画 | `src/schemas/data_models.py` |
| SearchResult | 検索結果 | `src/schemas/data_models.py` |
| ResearchReport | リサーチレポート | `src/schemas/data_models.py` |
| ResearchRequest | APIリクエスト | `src/api/schemas.py` |
| ResearchResponse | APIレスポンス | `src/api/schemas.py` |
| ProgressInfo | 進捗情報 | `src/api/schemas.py` |
| ResearchStatistics | 統計情報 | `src/api/schemas.py` |

---

## 3. コアデータモデル

### 3.1 ResearchState

LangGraphの共有ステート。全ノードが参照・更新する。

**ファイル**: `src/graph/state.py`

**定義**:

```python
from typing import TypedDict, List, Optional, Literal, Annotated
from langchain_core.messages import BaseMessage
from langgraph.graph.message import add_messages
from src.schemas.data_models import ResearchPlan, SearchResult

class ResearchState(TypedDict):
    """
    リサーチエージェントの共有ステート
    
    全ノードが共有・参照・更新するデータ構造
    """
    
    # メッセージ履歴（LangGraph標準、自動マージ）
    messages: Annotated[
        List[BaseMessage], 
        add_messages
    ]
    
    # 調査計画（初回はNone、Supervisorで生成）
    task_plan: Optional[ResearchPlan]
    
    # 収集された研究データ（Researcherが追加）
    research_data: List[SearchResult]
    
    # 現在のドラフト（Writerが生成）
    current_draft: Optional[str]
    
    # Reviewerからのフィードバック
    feedback: Optional[str]
    
    # ループ回数（各ノード実行時にインクリメント）
    iteration_count: int
    
    # 次のアクション（ルーティング決定用）
    next_action: Literal["research", "write", "review", "end"]
    
    # 人間介入フラグ
    human_input_required: bool
    
    # 人間からの入力
    human_input: Optional[str]
```

**フィールド詳細**:

| フィールド | 型 | 必須 | デフォルト | 説明 |
|-----------|-----|------|----------|------|
| messages | Annotated[List[BaseMessage], add_messages] | はい | [] | メッセージ履歴（自動マージ） |
| task_plan | Optional[ResearchPlan] | いいえ | None | 調査計画 |
| research_data | List[SearchResult] | はい | [] | 収集された検索結果 |
| current_draft | Optional[str] | いいえ | None | 現在のドラフト |
| feedback | Optional[str] | いいえ | None | Reviewerからのフィードバック |
| iteration_count | int | はい | 0 | ループ回数 |
| next_action | Literal["research", "write", "review", "end"] | はい | "research" | 次のアクション |
| human_input_required | bool | はい | False | 人間介入が必要か |
| human_input | Optional[str] | いいえ | None | 人間からの入力 |

**使用例**:

```python
from langchain_core.messages import HumanMessage

initial_state: ResearchState = {
    "messages": [HumanMessage(content="LangGraphについて調査してください")],
    "task_plan": None,
    "research_data": [],
    "current_draft": None,
    "feedback": None,
    "iteration_count": 0,
    "next_action": "research",
    "human_input_required": False,
    "human_input": None
}
```

---

### 3.2 ResearchPlan

調査計画モデル。Supervisorが生成する。

**ファイル**: `src/schemas/data_models.py`

**定義**:

```python
from pydantic import BaseModel, Field
from datetime import datetime
from typing import List, Dict

class ResearchPlan(BaseModel):
    """調査計画モデル"""
    
    theme: str = Field(..., description="調査テーマ", min_length=1, max_length=500)
    investigation_points: List[str] = Field(
        default_factory=list,
        description="調査観点のリスト",
        min_items=1,
        max_items=10
    )
    search_queries: List[str] = Field(
        default_factory=list,
        description="検索クエリのリスト",
        min_items=1,
        max_items=20
    )
    source_priority: Dict[str, int] = Field(
        default_factory=lambda: {"tavily": 1, "arxiv": 2},
        description="情報源の優先度（数値が小さいほど優先度が高い）"
    )
    plan_text: str = Field(..., description="人間可読な計画テキスト", min_length=10)
    created_at: datetime = Field(default_factory=datetime.now, description="作成日時")
    
    class Config:
        json_schema_extra = {
            "example": {
                "theme": "LangGraphについて調査してください",
                "investigation_points": [
                    "LangGraphの基本概念と特徴",
                    "LangGraphの用途とユースケース"
                ],
                "search_queries": [
                    "LangGraph framework",
                    "LangGraph use cases"
                ],
                "plan_text": "LangGraphについて包括的に調査します...",
                "created_at": "2024-12-27T10:00:00Z"
            }
        }
```

**フィールド詳細**:

| フィールド | 型 | 必須 | デフォルト | バリデーション | 説明 |
|-----------|-----|------|----------|--------------|------|
| theme | string | はい | - | 1-500文字 | 調査テーマ |
| investigation_points | array[string] | はい | [] | 1-10項目 | 調査観点のリスト |
| search_queries | array[string] | はい | [] | 1-20項目 | 検索クエリのリスト |
| source_priority | object | いいえ | {"tavily": 1, "arxiv": 2} | - | 情報源の優先度 |
| plan_text | string | はい | - | 10文字以上 | 計画テキスト |
| created_at | datetime | いいえ | 現在時刻 | - | 作成日時 |

**バリデーションルール**:

- `theme`: 空文字列不可、最大500文字
- `investigation_points`: 1項目以上、最大10項目
- `search_queries`: 1項目以上、最大20項目
- `plan_text`: 10文字以上

**使用例**:

```python
plan = ResearchPlan(
    theme="LangGraphについて調査してください",
    investigation_points=[
        "LangGraphの基本概念と特徴",
        "LangGraphの用途とユースケース"
    ],
    search_queries=[
        "LangGraph framework",
        "LangGraph use cases"
    ],
    plan_text="LangGraphについて包括的に調査します..."
)

# JSONシリアライゼーション
plan_dict = plan.model_dump()
plan_json = plan.model_dump_json()
```

---

### 3.3 SearchResult

検索結果モデル。Researcherが収集する。

**ファイル**: `src/schemas/data_models.py`

**定義**:

```python
from pydantic import BaseModel, Field, HttpUrl
from typing import List, Optional, Literal

class SearchResult(BaseModel):
    """検索結果モデル（共通スキーマ）"""
    
    title: str = Field(..., description="タイトル", min_length=1, max_length=500)
    summary: str = Field(..., description="要約", min_length=1, max_length=2000)
    source: Literal["tavily", "arxiv"] = Field(..., description="情報源")
    url: str = Field(..., description="URL", pattern=r"^https?://")
    published_date: Optional[str] = Field(
        None,
        description="公開日",
        pattern=r"^\d{4}-\d{2}-\d{2}$"
    )
    authors: Optional[List[str]] = Field(
        None,
        description="著者リスト（arXiv用）",
        max_items=50
    )
    categories: Optional[List[str]] = Field(
        None,
        description="カテゴリリスト（arXiv用）",
        max_items=20
    )
    relevance_score: Optional[float] = Field(
        None,
        description="関連性スコア",
        ge=0.0,
        le=1.0
    )
    
    class Config:
        json_schema_extra = {
            "example": {
                "title": "LangGraph Documentation",
                "summary": "LangGraphの公式ドキュメント...",
                "source": "tavily",
                "url": "https://langchain-ai.github.io/langgraph/",
                "published_date": "2024-01-01",
                "relevance_score": 0.95
            }
        }
```

**フィールド詳細**:

| フィールド | 型 | 必須 | デフォルト | バリデーション | 説明 |
|-----------|-----|------|----------|--------------|------|
| title | string | はい | - | 1-500文字 | タイトル |
| summary | string | はい | - | 1-2000文字 | 要約 |
| source | Literal["tavily", "arxiv"] | はい | - | - | 情報源 |
| url | string | はい | - | HTTP/HTTPS URL形式 | URL |
| published_date | string | いいえ | None | YYYY-MM-DD形式 | 公開日 |
| authors | array[string] | いいえ | None | 最大50項目 | 著者リスト |
| categories | array[string] | いいえ | None | 最大20項目 | カテゴリリスト |
| relevance_score | float | いいえ | None | 0.0-1.0 | 関連性スコア |

**バリデーションルール**:

- `title`: 空文字列不可、最大500文字
- `summary`: 空文字列不可、最大2000文字
- `url`: HTTP/HTTPS URL形式であること
- `published_date`: YYYY-MM-DD形式（オプション）
- `relevance_score`: 0.0以上1.0以下

**使用例**:

```python
result = SearchResult(
    title="LangGraph Documentation",
    summary="LangGraphの公式ドキュメント...",
    source="tavily",
    url="https://langchain-ai.github.io/langgraph/",
    relevance_score=0.95
)

# URL検証
try:
    result = SearchResult(
        title="Test",
        summary="Test summary",
        source="tavily",
        url="invalid-url"  # バリデーションエラー
    )
except ValidationError as e:
    print(e)
```

---

### 3.4 ResearchReport

リサーチレポートモデル。Writerが生成する。

**ファイル**: `src/schemas/data_models.py`

**定義**:

```python
from pydantic import BaseModel, Field
from datetime import datetime
from typing import List

class ResearchReport(BaseModel):
    """リサーチレポートモデル"""
    
    theme: str = Field(..., description="調査テーマ", min_length=1, max_length=500)
    executive_summary: str = Field(
        ...,
        description="エグゼクティブサマリー",
        min_length=50,
        max_length=1000
    )
    key_findings: List[str] = Field(
        default_factory=list,
        description="主要発見のリスト",
        min_items=1,
        max_items=20
    )
    detailed_analysis: str = Field(
        ...,
        description="詳細解説",
        min_length=100
    )
    constraints_and_challenges: str = Field(
        default="",
        description="制約・課題",
        max_length=2000
    )
    sources: List[SearchResult] = Field(
        default_factory=list,
        description="参考ソース一覧"
    )
    generated_at: datetime = Field(
        default_factory=datetime.now,
        description="生成日時"
    )
    
    def to_markdown(self) -> str:
        """Markdown形式に変換"""
        md_lines = [
            f"# {self.theme}",
            "",
            "## Executive Summary",
            "",
            self.executive_summary,
            "",
            "## Key Findings",
            ""
        ]
        
        for i, finding in enumerate(self.key_findings, 1):
            md_lines.append(f"{i}. {finding}")
        
        md_lines.extend([
            "",
            "## Detailed Analysis",
            "",
            self.detailed_analysis,
            ""
        ])
        
        if self.constraints_and_challenges:
            md_lines.extend([
                "## Constraints and Challenges",
                "",
                self.constraints_and_challenges,
                ""
            ])
        
        md_lines.extend([
            "## References",
            ""
        ])
        
        for i, source in enumerate(self.sources, 1):
            md_lines.append(f"{i}. **{source.title}**")
            md_lines.append(f"   - Source: {source.source}")
            md_lines.append(f"   - URL: {source.url}")
            if source.published_date:
                md_lines.append(f"   - Published: {source.published_date}")
            if source.authors:
                md_lines.append(f"   - Authors: {', '.join(source.authors)}")
            md_lines.append("")
        
        md_lines.append(
            f"\n*Generated at: {self.generated_at.strftime('%Y-%m-%d %H:%M:%S')}*"
        )
        
        return "\n".join(md_lines)
    
    class Config:
        json_schema_extra = {
            "example": {
                "theme": "LangGraphについて調査してください",
                "executive_summary": "LangGraphは...",
                "key_findings": [
                    "発見1",
                    "発見2"
                ],
                "detailed_analysis": "詳細な分析...",
                "constraints_and_challenges": "制約と課題...",
                "sources": [],
                "generated_at": "2024-12-27T10:02:00Z"
            }
        }
```

**フィールド詳細**:

| フィールド | 型 | 必須 | デフォルト | バリデーション | 説明 |
|-----------|-----|------|----------|--------------|------|
| theme | string | はい | - | 1-500文字 | 調査テーマ |
| executive_summary | string | はい | - | 50-1000文字 | エグゼクティブサマリー |
| key_findings | array[string] | はい | [] | 1-20項目 | 主要発見のリスト |
| detailed_analysis | string | はい | - | 100文字以上 | 詳細解説 |
| constraints_and_challenges | string | いいえ | "" | 最大2000文字 | 制約・課題 |
| sources | array[SearchResult] | はい | [] | - | 参考ソース一覧 |
| generated_at | datetime | いいえ | 現在時刻 | - | 生成日時 |

**メソッド**:

- `to_markdown() -> str`: マークダウン形式に変換

**使用例**:

```python
report = ResearchReport(
    theme="LangGraphについて調査してください",
    executive_summary="LangGraphは...",
    key_findings=["発見1", "発見2"],
    detailed_analysis="詳細な分析...",
    sources=[search_result1, search_result2]
)

# マークダウン形式に変換
markdown = report.to_markdown()

# JSON形式に変換
report_dict = report.model_dump()
report_json = report.model_dump_json()
```

---

## 4. APIデータモデル

### 4.1 ResearchRequest

リサーチ開始リクエストモデル。

**ファイル**: `src/api/schemas.py`

**定義**:

```python
from pydantic import BaseModel, Field
from typing import Optional

class ResearchRequest(BaseModel):
    """リサーチ開始リクエスト"""
    
    theme: str = Field(..., description="調査テーマ", min_length=1, max_length=500)
    max_iterations: int = Field(
        default=5,
        description="最大イテレーション数",
        ge=1,
        le=10
    )
    enable_human_intervention: bool = Field(
        default=False,
        description="人間介入を有効化するか"
    )
    checkpointer_type: str = Field(
        default="memory",
        description="チェックポイントタイプ",
        pattern="^(memory|redis)$"
    )
    
    class Config:
        json_schema_extra = {
            "example": {
                "theme": "LangGraphについて調査してください",
                "max_iterations": 5,
                "enable_human_intervention": False,
                "checkpointer_type": "memory"
            }
        }
```

**フィールド詳細**:

| フィールド | 型 | 必須 | デフォルト | バリデーション | 説明 |
|-----------|-----|------|----------|--------------|------|
| theme | string | はい | - | 1-500文字 | 調査テーマ |
| max_iterations | integer | いいえ | 5 | 1-10 | 最大イテレーション数 |
| enable_human_intervention | boolean | いいえ | False | - | 人間介入を有効化するか |
| checkpointer_type | string | いいえ | "memory" | "memory" or "redis" | チェックポイントタイプ |

---

### 4.2 ResearchResponse

リサーチ開始レスポンスモデル。

**ファイル**: `src/api/schemas.py`

**定義**:

```python
from pydantic import BaseModel, Field
from datetime import datetime
from typing import Optional
import uuid

class ResearchResponse(BaseModel):
    """リサーチ開始レスポンス"""
    
    research_id: str = Field(..., description="リサーチID（UUID）")
    status: str = Field(
        ...,
        description="ステータス",
        pattern="^(started|processing|completed|failed|interrupted)$"
    )
    message: str = Field(..., description="メッセージ")
    created_at: datetime = Field(..., description="作成日時")
    estimated_completion_time: Optional[datetime] = Field(
        None,
        description="推定完了時刻"
    )
```

**フィールド詳細**:

| フィールド | 型 | 必須 | デフォルト | 説明 |
|-----------|-----|------|----------|------|
| research_id | string (UUID) | はい | - | リサーチID |
| status | string | はい | - | ステータス |
| message | string | はい | - | メッセージ |
| created_at | datetime | はい | - | 作成日時 |
| estimated_completion_time | datetime | いいえ | None | 推定完了時刻 |

---

### 4.3 ProgressInfo

進捗情報モデル。

**ファイル**: `src/api/schemas.py`

**定義**:

```python
from pydantic import BaseModel, Field
from typing import List

class ProgressInfo(BaseModel):
    """進捗情報"""
    
    current_iteration: int = Field(..., description="現在のイテレーション", ge=0)
    max_iterations: int = Field(..., description="最大イテレーション数", ge=1)
    current_node: str = Field(
        ...,
        description="現在実行中のノード",
        pattern="^(supervisor|researcher|writer|reviewer)$"
    )
    nodes_completed: List[str] = Field(
        default_factory=list,
        description="完了したノードのリスト"
    )
    nodes_remaining: List[str] = Field(
        default_factory=list,
        description="残りのノードのリスト"
    )
```

**フィールド詳細**:

| フィールド | 型 | 必須 | デフォルト | 説明 |
|-----------|-----|------|----------|------|
| current_iteration | integer | はい | - | 現在のイテレーション |
| max_iterations | integer | はい | - | 最大イテレーション数 |
| current_node | string | はい | - | 現在実行中のノード |
| nodes_completed | array[string] | はい | [] | 完了したノードのリスト |
| nodes_remaining | array[string] | はい | [] | 残りのノードのリスト |

---

### 4.4 ResearchStatistics

統計情報モデル。

**ファイル**: `src/api/schemas.py`

**定義**:

```python
from pydantic import BaseModel, Field

class ResearchStatistics(BaseModel):
    """統計情報"""
    
    iterations: int = Field(..., description="イテレーション回数", ge=0)
    sources_collected: int = Field(..., description="収集されたソース数", ge=0)
    processing_time_seconds: int = Field(..., description="処理時間（秒）", ge=0)
```

**フィールド詳細**:

| フィールド | 型 | 必須 | デフォルト | 説明 |
|-----------|-----|------|----------|------|
| iterations | integer | はい | - | イテレーション回数 |
| sources_collected | integer | はい | - | 収集されたソース数 |
| processing_time_seconds | integer | はい | - | 処理時間（秒） |

---

## 5. バリデーションルール一覧

### 5.1 文字列バリデーション

| フィールド | 最小長 | 最大長 | パターン |
|-----------|--------|--------|---------|
| theme | 1 | 500 | - |
| plan_text | 10 | - | - |
| title | 1 | 500 | - |
| summary | 1 | 2000 | - |
| url | - | - | `^https?://` |
| published_date | - | - | `^\d{4}-\d{2}-\d{2}$` |
| executive_summary | 50 | 1000 | - |
| detailed_analysis | 100 | - | - |
| constraints_and_challenges | - | 2000 | - |

### 5.2 数値バリデーション

| フィールド | 最小値 | 最大値 |
|-----------|--------|--------|
| max_iterations | 1 | 10 |
| relevance_score | 0.0 | 1.0 |
| iterations | 0 | - |
| sources_collected | 0 | - |
| processing_time_seconds | 0 | - |

### 5.3 配列バリデーション

| フィールド | 最小項目数 | 最大項目数 |
|-----------|-----------|-----------|
| investigation_points | 1 | 10 |
| search_queries | 1 | 20 |
| key_findings | 1 | 20 |
| authors | - | 50 |
| categories | - | 20 |

---

## 6. データモデル間の関係

### 6.1 関係図

```
ResearchState
├── task_plan: ResearchPlan
├── research_data: List[SearchResult]
└── current_draft: str (ResearchReportのマークダウン)

ResearchPlan
└── (独立)

SearchResult
└── (独立)

ResearchReport
├── sources: List[SearchResult]
└── (独立)

API Models
├── ResearchRequest → ResearchState
├── ResearchResponse
├── ProgressInfo
└── ResearchStatistics
```

### 6.2 変換マッピング

**ResearchState → ResearchReport**:

```python
def state_to_report(state: ResearchState) -> ResearchReport:
    """ステートからレポートを生成"""
    plan = state["task_plan"]
    return ResearchReport(
        theme=plan.theme if plan else "",
        executive_summary=extract_summary(state["current_draft"]),
        key_findings=extract_findings(state["current_draft"]),
        detailed_analysis=extract_analysis(state["current_draft"]),
        sources=state["research_data"],
        generated_at=datetime.now()
    )
```

---

## 7. JSONスキーマ

### 7.1 ResearchPlan JSONスキーマ

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "required": ["theme", "investigation_points", "search_queries", "plan_text"],
  "properties": {
    "theme": {
      "type": "string",
      "minLength": 1,
      "maxLength": 500
    },
    "investigation_points": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "minItems": 1,
      "maxItems": 10
    },
    "search_queries": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "minItems": 1,
      "maxItems": 20
    },
    "plan_text": {
      "type": "string",
      "minLength": 10
    },
    "created_at": {
      "type": "string",
      "format": "date-time"
    }
  }
}
```

### 7.2 SearchResult JSONスキーマ

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "required": ["title", "summary", "source", "url"],
  "properties": {
    "title": {
      "type": "string",
      "minLength": 1,
      "maxLength": 500
    },
    "summary": {
      "type": "string",
      "minLength": 1,
      "maxLength": 2000
    },
    "source": {
      "type": "string",
      "enum": ["tavily", "arxiv"]
    },
    "url": {
      "type": "string",
      "pattern": "^https?://"
    },
    "relevance_score": {
      "type": "number",
      "minimum": 0.0,
      "maximum": 1.0
    }
  }
}
```

---

## 8. 使用例

### 8.1 モデルの作成

```python
from src.schemas.data_models import ResearchPlan, SearchResult, ResearchReport
from datetime import datetime

# ResearchPlanの作成
plan = ResearchPlan(
    theme="LangGraphについて調査してください",
    investigation_points=[
        "LangGraphの基本概念と特徴",
        "LangGraphの用途とユースケース"
    ],
    search_queries=[
        "LangGraph framework",
        "LangGraph use cases"
    ],
    plan_text="LangGraphについて包括的に調査します..."
)

# SearchResultの作成
result = SearchResult(
    title="LangGraph Documentation",
    summary="LangGraphの公式ドキュメント...",
    source="tavily",
    url="https://langchain-ai.github.io/langgraph/",
    relevance_score=0.95
)

# ResearchReportの作成
report = ResearchReport(
    theme="LangGraphについて調査してください",
    executive_summary="LangGraphは...",
    key_findings=["発見1", "発見2"],
    detailed_analysis="詳細な分析...",
    sources=[result]
)
```

### 8.2 バリデーション

```python
from pydantic import ValidationError

try:
    plan = ResearchPlan(
        theme="",  # バリデーションエラー
        investigation_points=[],
        search_queries=[],
        plan_text=""
    )
except ValidationError as e:
    print(e.json())
```

### 8.3 JSONシリアライゼーション

```python
# モデル → 辞書
plan_dict = plan.model_dump()

# モデル → JSON文字列
plan_json = plan.model_dump_json()

# 辞書 → モデル
plan_from_dict = ResearchPlan(**plan_dict)

# JSON文字列 → モデル
import json
plan_from_json = ResearchPlan.model_validate_json(plan_json)
```

---

## 9. 変更履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| 1.0 | 2024-12-27 | 初版作成 |

---

## 付録A: 参考資料

- Pydantic Documentation
- JSON Schema Specification
- Python Type Hints

