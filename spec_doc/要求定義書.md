
# 要件定義書：LangGraph搭載 自律型リサーチエージェント

## 1. システム概要

目的: ユーザーが入力したテーマに対し、Web上の情報を多角的に収集・検証し、高品質なレポートを自律的に作成する。

特徴: LangGraphのステートフルなグラフ構造を利用し、検索・執筆・レビューのサイクル（循環ループ）を回すことで、情報の網羅性と正確性を担保する。

## 2. エージェント構成（Actor定義）

システムを構成する各エージェント（Node）の役割定義です。

|**エージェント名**|**役割 (Role)**|**主な機能・ツール**|
|---|---|---|
|**1. Supervisor**<br><br>  <br><br>(監督・ルーター)|**司令塔**|・ユーザー指示の分解・計画立案 (Planning)<br><br>  <br><br>・次のタスクをどのWorkerに割り振るかの意思決定 (Routing)<br><br>  <br><br>・終了判定 (検索十分か、品質OKか)|
|**2. Researcher**<br><br>  <br><br>(調査担当)|**情報収集**|・検索クエリの生成<br><br>  <br><br>・Web検索ツールの実行 (Tavily/Google API)<br><br>  <br><br>・検索結果のスクレイピングと要約<br><br>  <br><br>・ソースURLの記録|
|**3. Writer**<br><br>  <br><br>(執筆担当)|**集約・執筆**|・収集された情報の統合<br><br>  <br><br>・論理構成の整理<br><br>  <br><br>・指定フォーマット（マークダウン等）でのドラフト作成|
|**4. Reviewer**<br><br>  <br><br>(品質管理)|**批評・検証**|・ドラフトのファクトチェック（幻覚の検知）<br><br>  <br><br>・情報の不足指摘<br><br>  <br><br>・出典（引用）の正確性確認<br><br>  <br><br>・改善指示のフィードバック|

## 3. 機能要件 (Functional Requirements)

### 3-1. ワークフロー制御 (Graph Control)

LangGraphの特性である「循環グラフ」を活用し、以下のフローを実現する。

1. **Input:** ユーザーからのテーマ入力。
    
2. **Plan:** Supervisorが調査計画を策定。
    
3. **Execute Loop:**
    
    - SupervisorがResearcherに調査を指示。
        
    - Researcherが検索結果を**共有ステート（State）**に書き込む。
        
    - （必要に応じて複数回検索を実行）
        
4. **Synthesize:** 十分な情報が集まったらWriterがドラフトを作成。
    
5. **Critique:** Reviewerがドラフトを評価。
    
    - _合格の場合:_ 終了（End）。
        
    - _不合格の場合:_ 修正指示をStateに書き込み、Supervisorへ戻る（再検索または再執筆へ）。
        

### 3-2. ステート管理 (State Management)

全エージェントが共有・参照・更新するデータ構造（Schema）。

- **messages:** 会話履歴（ChatHistory）。各エージェントのやり取りを保持。
    
- **task_plan:** 現在の調査計画リスト。
    
- **research_data:** 収集された生データと出典元（URL, Title, Snippet）。
    
- **current_draft:** 現在作成中のレポート原稿。
    
- **feedback:** Reviewerからの修正コメント。
    
- **iteration_count:** ループ回数（無限ループ防止用）。
    

### 3-3. 外部ツール連携 (Tool Use)

- **Search Tool:** 最新情報を取得するための検索API (Tavily Search API推奨)。
    
- **Scraper:** 特定URLの詳細内容を取得するツール。
    

### 3-4. Human-in-the-loop (人間介入)

- **承認フロー:** 最終出力の直前、または重要な検索方針の決定時に、グラフの実行を一時停止（`interrupt_before`）し、人間の承認または修正入力を受け付ける機能。
    

## 4. 非機能要件 (Non-Functional Requirements)

- **信頼性 (Reliability):**
    
    - 最大ループ回数（例: 5回）を設定し、永遠に回答しない事態を防ぐ。
        
    - 検索エラー時の再試行（リトライ）ロジックの実装。
        
- **追跡可能性 (Observability):**
    
    - 各エージェントが「なぜその行動をとったか」の思考プロセス（Chain of Thought）をログとして保存する（LangSmith等の利用）。
        
- **永続性 (Persistence):**
    
    - LangGraphのCheckpointerを使用し、会話の途中から再開できる機能を実装する（セッション管理）。
        

## 5. 技術スタック案

- **Orchestration:** LangGraph, LangChain

- **LLM:** OpenAI GPT-4o（推奨）、Google Gemini（オプション）、Mock（開発・テスト用、APIキー不要）

- **Search API:** Tavily API（LLM向けに最適化されており、ノイズ除去済みの結果を返すため）

- **Backend:** Python (FastAPI)、起動は `run_api_server.py` または `start_api_server.bat`（Windows）

- **GUI:** HTML/CSS/JavaScript（`gui/`、推奨）および Streamlit（`examples/api_usage_with_chat_gui.py` 利用時）

- **Database:** Redis or Postgres（Checkpointerによる会話履歴の永続化用、オプション）
    

## 6. アーキテクチャ図（概念）

コード スニペット

```
graph TD
    User((User)) -->|Input| Supervisor
    
    subgraph "LangGraph Agent Workflow"
        Supervisor{Supervisor Node<br>Manager}
        
        Supervisor -->|Research Request| Researcher[Researcher Node<br>Web Search]
        Supervisor -->|Write Request| Writer[Writer Node<br>Drafting]
        
        Researcher -->|Result to State| Supervisor
        Writer -->|Draft to State| Reviewer[Reviewer Node<br>Critique]
        
        Reviewer -->|Approved| End((End))
        Reviewer -->|Rejected / Needs Info| Supervisor
    end

    style Supervisor fill:#f9f,stroke:#333,stroke-width:4px
    style Researcher fill:#bbf,stroke:#333
    style Writer fill:#bfb,stroke:#333
    style Reviewer fill:#fbb,stroke:#333
```
